# Mnemosyne Protocol Specification v1.0

This document defines the Mnemosyne Protocol (MNP), a JSON-RPC 2.0 based protocol for managing code history and semantic snapshots. It is inspired by the Language Server Protocol (LSP) and designed for interoperability between daemons, CLIs, TUIs, and IDE extensions.

## 1. Transport

The protocol uses **JSON-RPC 2.0** over a reliable transport layer:
- **Windows**: Named Pipes (e.g., `\\.\pipe\mnemosyne-daemon`)
- **Unix (Linux/macOS)**: Unix Domain Sockets (e.g., `/tmp/mnemosyne.sock`)

## 2. Lifecycle

A client must follow this lifecycle to interact with the server:

### 2.1 Initialization

Before sending any other requests (except for `mnem/daemon/status`), the client **MUST** call the `initialize` method.

**Method:** `initialize`
**Params:** `InitializeParams`
```json
{
  "client_info": { "name": "mnem-cli", "version": "0.2.0" },
  "capabilities": { "semantic_analysis": true, "git_integration": true }
}
```

**Response:** `InitializeResult`
```json
{
  "server_info": { "name": "mnemosyne", "version": "0.2.0" },
  "capabilities": {
    "protocol_version": "1.0.0",
    "supported_methods": ["mnem/project/watch", ...],
    "semantic_analysis": true,
    "git_integration": true
  },
  "protocol_version": "1.0.0"
}
```

### 2.2 Shutdown & Exit

To stop the server gracefully:
1. Send `shutdown` request (server stops accepting new requests).
2. Send `exit` notification (server process terminates).

## 3. Method Naming & Namespaces

Standardized methods use the `mnem/` prefix to avoid collisions.

| Category | Standardized Method (v1.0) | Legacy Method (Deprecated) |
|----------|----------------------------|----------------------------|
| Project | `mnem/project/watch` | `project/watch` |
| | `mnem/project/list` | `project/get_watched` |
| Snapshot | `mnem/snapshot/create` | `snapshot/save` |
| | `mnem/snapshot/list` | `snapshot/history` |
| Symbol | `mnem/symbol/history` | `symbol/history` |
| Daemon | `mnem/daemon/status` | `daemon/status` |

*Note: The server maintains backward compatibility by automatically normalizing legacy names to v1.0 names.*

## 4. Error Codes

### Standard JSON-RPC 2.0 Errors
- `-32700`: Parse Error
- `-32600`: Invalid Request
- `-32601`: Method Not Found
- `-32602`: Invalid Params
- `-32603`: Internal Error

### Mnemosyne Specific Errors
- `-32100`: Server Not Initialized
- `-32101`: Already Initialized
- `-32102`: Unauthorized
- `-32103`: Project Not Found
- `-32104`: Snapshot Not Found
- `-32106`: Storage Error

## 5. Security

Clients must include an `auth_token` in the `JsonRpcRequest` envelope for all restricted methods. The token is typically generated by the daemon and shared via a secure local file (e.g., `~/.mnemosyne/.auth_token`).
